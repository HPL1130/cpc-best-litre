<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>中油自助最划算公升數</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00664F">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,"Microsoft JhengHei",sans-serif;background:#f5f5f5;color:#333;background:linear-gradient(135deg,#e8f5e8, #d0f0d0)}
header{background:#00664F;color:#fff;padding:2rem 1rem;text-align:center}
h1{font-size:1.8rem;margin-bottom:.5rem}
.choose{text-align:center;padding:2rem}
.choose button{background:#00664F;color:#fff;border:none;padding:1.5rem 3rem;font-size:1.8rem;margin:0 1rem;border-radius:16px;width:80%;max-width:300px;box-shadow:0 8px 20px rgba(0,100,79,.3)}
.back{position:absolute;left:15px;top:18px;color:#fff;font-size:2rem;text-decoration:none;display:none}
.container{max-width:1000px;margin:0 auto;padding:1rem;display:none}
.controls{background:#fff;padding:1.5rem;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.15);text-align:center;margin-bottom:1rem}
#discInput{font-size:1.8rem;padding:1rem;width:180px;border-radius:12px;border:2px solid #00664F;text-align:center;font-weight:bold}
#date{font-size:1.2rem;color:#00664F;font-weight:bold;margin:1rem 0}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,.15);font-size:1.05rem}
th{background:#00664F;color:#fff;padding:1.2rem .8rem;font-size:1rem}
td{padding:1rem .5rem;text-align:center}
tr:nth-child(even){background:#f8fff8}
.best{background:#fff8e1!important;font-weight:bold;font-size:1.1rem}
.o92{color:#d32f2f}
.o95{color:#f57c00}
</style>
</head>
<body>

<div class="back" id="backBtn">返回</div>
<header>
  <h1>中油自助最划算公升數</h1>
  <div style="font-size:1.1rem;opacity:0.9">請選擇您的油種</div>
</header>

<div class="choose" id="chooseOil">
  <button onclick="selectOil(92)">92 無鉛汽油</button><br><br>
  <button onclick="selectOil(95)">95 無鉛汽油</button>
</div>

<div class="container" id="main">
  <div id="date">抓油價中…</div>
  
  <div class="controls">
    <div style="font-size:1.4rem;margin-bottom:1rem">
      <span id="oilName">92</span> 自助優惠
    </div>
    <input type="number" step="0.1" min="0" max="9.9" value="2.0" id="discInput">
    <span style="font-size:1.8rem;font-weight:bold;color:#00664F"> 元/公升</span>
  </div>

  <table>
    <thead><tr>
      <th>排名</th><th>加油公升</th><th>原價總額</th><th>自助總額</th><th>優惠金額</th><th>實際單價</th><th>省下</th>
    </tr></thead>
    <tbody id="tb"></tbody>
  </table>
</div>

<script>
let currentOil = 0;
let p92 = 27.1, p95 = 28.6; // 2025.11.18 最新油價

// 完整方案表（滿額公升, 自助公升, 最高可折元數）
const schemes92 = [[45,44,1],[46,45,1],[47,46,1],[48,46,2],[48,47,1],[49,47,2],[49,48,1],[50,48,2],[50,49,1],[51,49,2],[51,50,1],[52,50,2],[52,51,1],[53,51,2],[53,52,1],[54,52,2],[55,53,2],[55,54,1],[56,55,1],[57,56,1],[58,57,1],[59,58,1],[60,59,1],[61,59,2],[62,60,2],[62,61,1],[63,61,2],[64,62,2],[64,63,1],[65,64,1],[66,64,2],[66,65,1],[67,66,1],[68,66,2],[67,65,2],[69,68,1],[70,68,2],[72,70,2],[73,71,2],[74,72,2],[75,73,2],[77,75,2],[81,78,3],[77,74,3],[79,77,2],[80,77,3],[79,76,3],[81,79,2],[82,79,3],[81,78,3],[84,81,3],[85,82,3],[86,84,2],[88,86,2],[89,86,3],[90,88,2],[91,88,3],[93,90,3],[95,93,2],[97,95,2],[104,102,2],[114,110,4],[120,118,4],[130,127,4],[140,137,4],[150,147,4],[160,157,4],[170,167,4],[180,177,4],[190,187,4],[200,197,4]];
const schemes95 = [[47,46,1],[48,47,1],[49,48,1],[50,48,2],[50,49,1],[51,49,2],[51,50,1],[52,51,1],[53,52,1],[54,53,1],[55,54,1],[56,55,1],[57,56,1],[58,57,1],[59,58,1],[61,60,1],[62,61,1],[64,63,1],[65,64,1],[68,67,1],[69,68,1],[72,70,2],[72,71,1],[76,74,2],[77,75,2],[79,77,2],[80,78,2],[83,81,2],[84,82,2],[86,84,2],[87,85,2],[90,88,2],[93,91,2],[94,92,2],[97,95,2],[100,98,2],[104,102,2],[114,112,2],[125,122,3],[130,127,3],[140,137,3],[150,147,3],[160,157,3],[170,167,3],[180,177,3],[190,187,3],[200,197,3]];

async function getPrice(){
  try{
    const r = await fetch('https://www.cpc.com.tw/GetOilPriceJson.aspx?x=1');
    const d = await r.json();
    const w = d.Data[0];
    p92 = parseFloat(w["92無鉛汽油"]);
    p95 = parseFloat(w["95無鉛汽油"]);
    document.getElementById("date").innerHTML = `最新油價 ${w.週別.replace('週','')}：92 = ${p92} 元　95 = ${p95} 元`;
  }catch(e){
    document.getElementById("date").innerHTML = `當週油價：92 = ${p92} 元　95 = ${p95} 元（離線模式）`;
  }
  if(currentOil) calc();
}

function selectOil(oil){
  currentOil = oil;
  document.getElementById("chooseOil").style.display = "none";
  document.getElementById("main").style.display = "block";
  document.getElementById("backBtn").style.display = "block";
  document.getElementById("oilName").textContent = oil===92?"92無鉛汽油":"95無鉛汽油";
  document.getElementById("oilName").className = oil===92?"o92":"o95";
  calc();
}

document.getElementById("backBtn").onclick = () => {
  document.getElementById("chooseOil").style.display = "block";
  document.getElementById("main").style.display = "none";
  document.getElementById("backBtn").style.display = "none";
};

function calc(){
  if(!currentOil) return;
  const discPerLitre = parseFloat(document.getElementById("discInput").value) || 0;
  const schemes = currentOil===92 ? schemes92 : schemes95;
  const price = currentOil===92 ? p92 : p95;
  const list = [];

  schemes.forEach(([fullL, selfL, maxDisc]) => {
    const disc = Math.min(maxDisc, discPerLitre * selfL);  // 優惠金額 = 每公升優惠 × 自助公升（但不超過上限）
    const cost = selfL * price - disc;
    const litre = cost / price;
    const realPrice = cost / litre;
    const save = fullL * price - cost;
    list.push({litre, realPrice, save, full:fullL*price, self:selfL*price, disc});
  });

  list.sort((a,b) => a.realPrice - b.realPrice);

  const tb = document.getElementById("tb");
  tb.innerHTML = "";
  list.forEach((x,i) => {
    const tr = document.createElement("tr");
    if(i===0) tr.className = "best";
    tr.innerHTML = `<td><b>${i+1}</b></td>
      <td><b>${x.litre.toFixed(2)}</b></td>
      <td>${x.full.toFixed(0)}</td>
      <td>${x.self.toFixed(0)}</td>
      <td>${x.disc.toFixed(1)}</td>
      <td><b>${x.realPrice.toFixed(2)}</b></td>
      <td>${x.save.toFixed(0)}</td>`;
    tb.appendChild(tr);
  });
}

document.getElementById("discInput").oninput = calc;
getPrice();
setInterval(getPrice, 86400000);
</script>
</body>
</html>
