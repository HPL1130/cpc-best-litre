<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>中油自助最划算公升數 Top20</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00664F">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,"Microsoft JhengHei",sans-serif;background:#f5f5f5;color:#333;line-height:1.6}
header{background:#00664F;color:#fff;padding:1.2rem;text-align:center}
h1{font-size:1.4rem}
.container{max-width:1000px;margin:0 auto;padding:1rem}
.controls{background:#fff;padding:1.3rem;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.1);margin-bottom:1rem;text-align:center}
select{font-size:1.1rem;padding:.7rem 1.2rem;border-radius:8px;margin:0 .4rem}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.1);font-size:.95rem}
th{background:#00664F;color:#fff;padding:1rem .5rem;font-size:.9rem}
td{padding:.9rem .5rem;text-align:center}
tr:nth-child(even){background:#fafafa}
.best{background:#fffbe6!important;font-weight:bold}
.o92{color:#d32f2f}
.o95{color:#f57c00}
#last{font-size:.8rem;color:#666;margin-top:1rem;text-align:center}
@media(max-width:640px){
  select{width:90%;display:block;margin:.6rem auto}
  th,td{font-size:.88rem;padding:.6rem .2rem}
}
</style>
</head>
<body>
<header><h1>中油自助最划算公升數 Top20</h1></header>
<div class="container">
  <div class="controls">
    <div id="date">抓取最新油價中…</div><br>
    92 自助優惠 <select id="d92">
      <option value="0">0元</option><option value="1">1元</option><option value="2" selected>2元</option><option value="3">3元</option><option value="4">4元</option>
    </select>
    95 自助優惠 <select id="d95">
      <option value="0">0元</option><option value="1">1元</option><option value="2" selected>2元</option><option value="3">3元</option><option value="4">4元</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>排名</th><th>油種</th><th>公升數</th><th>原價總額</th><th>自助總額</th><th>非自助單價</th><th>自助實際單價</th>
      </tr>
    </thead>
    <tbody id="tb"></tbody>
  </table>
  <div id="last"></div>
</div>

<script>
let p92 = 27.1, p95 = 28.6;

async function getPrice(){
  try{
    const r = await fetch("https://corsproxy.io/?https://www.cpc.com.tw/cp.aspx?n=38");
    const t = await r.text();
    const doc = new DOMParser().parseFromString(t,"text/html");
    const v92 = doc.querySelector("table tbody tr:nth-child(2) td:nth-child(3)")?.textContent.trim();
    const v95 = doc.querySelector("table tbody tr:nth-child(3) td:nth-child(3)")?.textContent.trim();
    if(v92) p92 = parseFloat(v92);
    if(v95) p95 = parseFloat(v95);
    document.getElementById("date").innerHTML = `當週油價：92 = <b>${p92}</b> 元　95 = <b>${p95}</b> 元　(已自動更新)`;
  }catch(e){
    document.getElementById("date").innerHTML = `當週油價：92 = ${p92} 元　95 = ${p95} 元　(離線模式)`;
  }
  calc();
}

const data92 = [[45,44,1],[46,45,1],[47,46,1],[48,46,2],[48,47,1],[49,47,2],[49,48,1],[50,48,2],[50,49,1],[51,49,2],[51,50,1],[52,50,2],[52,51,1],[53,51,2],[53,52,1],[54,52,2],[55,53,2],[55,54,1],[56,55,1],[57,56,1],[58,57,1],[59,58,1],[60,59,1],[61,59,2],[62,60,2],[62,61,1],[63,61,2],[64,62,2],[64,63,1],[65,64,1],[66,64,2],[66,65,1],[67,66,1],[68,66,2],[67,65,2],[69,68,1],[70,68,2],[72,70,2],[72,70,2],[73,71,2],[74,72,2],[75,73,2],[75,73,2],[77,75,2],[81,78,3],[77,75,2],[77,74,3],[79,77,2],[80,77,3],[79,76,3],[81,79,2],[82,79,3],[81,78,3],[84,81,3],[85,82,3],[86,84,2],[88,86,2],[89,86,3],[90,88,2],[91,88,3],[93,90,3],[95,93,2],[97,95,2],[104,102,2],[104,102,2],[114,110,4]];
const data95 = [[47,46,1],[48,47,1],[49,48,1],[50,48,2],[50,49,1],[51,49,2],[51,50,1],[52,51,1],[53,52,1],[54,53,1],[55,54,1],[56,55,1],[57,56,1],[58,57,1],[59,58,1],[61,60,1],[62,61,1],[64,63,1],[65,64,1],[68,67,1],[69,68,1],[72,70,2],[72,71,1],[76,74,2],[77,75,2],[79,77,2],[80,78,2],[83,81,2],[84,82,2],[86,84,2],[87,85,2],[90,88,2],[93,91,2],[94,92,2],[97,95,2],[100,98,2],[104,102,2],[114,112,2],[125,122,3]];

function calc(){
  const disc92 = +document.getElementById("d92").value;
  const disc95 = +document.getElementById("d95").value;
  const list = [];

  data92.forEach(v => {
    const [fullL, selfL, maxD] = v;
    const d = Math.min(maxD, disc92);
    const fullTotal = Math.round(fullL * p92);
    const selfTotal = Math.round(selfL * p92) - d;
    const realPrice = (selfTotal / selfL).toFixed(2);
    list.push({oil:"92", l:selfL, full:fullTotal, self:selfTotal, normal:p92.toFixed(2), real:realPrice});
  });

  data95.forEach(v => {
    const [fullL, selfL, maxD] = v;
    const d = Math.min(maxD, disc95);
    const fullTotal = Math.round(fullL * p95);
    const selfTotal = Math.round(selfL * p95) - d;
    const realPrice = (selfTotal / selfL).toFixed(2);
    list.push({oil:"95", l:selfL, full:fullTotal, self:selfTotal, normal:p95.toFixed(2), real:realPrice});
  });

  list.sort((a,b)=>a.real-b.real);

  const tb = document.getElementById("tb");
  tb.innerHTML="";
  list.slice(0,20).forEach((x,i)=>{
    const tr = document.createElement("tr");
    if(i===0) tr.className="best";
    tr.innerHTML = `<td><b>${i+1}</b></td><td><span class="o${x.oil}"><b>${x.oil}</b></span></td><td><b>${x.l}</b></td><td>${x.full}</td><td>${x.self}</td><td>${x.normal}</td><td><b>${x.real}</b></td>`;
    tb.appendChild(tr);
  });

  document.getElementById("last").textContent = "最後計算：" + new Date().toLocaleString("zh-TW");
}

document.getElementById("d92").addEventListener("change", calc);
document.getElementById("d95").addEventListener("change", calc);

getPrice();
setInterval(getPrice, 86400000);
</script>
</body>
</html>
