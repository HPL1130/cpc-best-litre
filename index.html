<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>中油自助最划算公升數</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00664F">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,"Microsoft JhengHei",sans-serif;background:#f5f5f5;color:#333}
header{background:#00664F;color:#fff;padding:1.5rem;text-align:center;position:relative}
h1{font-size:1.5rem}
.back{position:absolute;left:15px;top:18px;color:#fff;font-size:2rem;text-decoration:none;display:none}
.container{max-width:1000px;margin:0 auto;padding:1rem}
.tabs{text-align:center;margin-bottom:1rem;display:none}
.tabs button{background:#00664F;color:#fff;border:none;padding:1rem 2rem;font-size:1.3rem;margin:0 5px;border-radius:8px;min-width:140px}
.tabs button.active{background:#004430}
.controls{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.1);text-align:center;margin-bottom:1rem}
input{font-size:1.2rem;padding:.8rem 1rem;border-radius:8px;border:1px solid #ddd;width:120px}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.1);font-size:1rem}
th{background:#00664F;color:#fff;padding:1rem .5rem;font-size:.95rem}
td{padding:.9rem .5rem;text-align:center}
tr:nth-child(even){background:#fafafa}
.best{background:#fff8e1!important;font-weight:bold}
.o92{color:#d32f2f}
.o95{color:#f57c00}
#date{font-size:1.1rem;color:#00664F;font-weight:bold;margin-bottom:.5rem;text-align:center}
@media(max-width:640px){
  .tabs button{display:block;width:90%;margin:8px auto}
  input{width:90%}
}
</style>
</head>
<body>

<a href="/" class="back" id="back">←</a>
<header><h1 id="title">中油自助最划算公升數 Top20</h1></header>

<div class="container">
  <div id="date">抓油價中…</div>

  <!-- 首頁兩個按鈕，點了才出現返回鍵 -->
  <div class="tabs" id="tabs">
    <button onclick="showOil(92)">92無鉛完整榜</button>
    <button onclick="showOil(95)">95無鉛完整榜</button>
  </div>

  <div class="controls">
    92 自助優惠 <input type="number" step="0.1" min="0" max="9.9" value="2.0" id="d92"> 元　
    95 自助優惠 <input type="number" step="0.1" min="0" max="9.9" value="2.0" id="d95"> 元
  </div>

  <table>
    <thead><tr><th>排名</th><th>油種</th><th>加油<br>公升</th><th>原價<br>總額</th><th>自助<br>總額</th><th>優惠<br>金額</th><th>實際<br>單價</th><th>省下</th></tr></thead>
    <tbody id="tb"></tbody>
  </table>
</div>

<script>
let p92=0, p95=0, mode="home"; // home = 混合Top20, 92=只秀92, 95=只秀95

async function getPrice(){
  try{
    const r = await fetch('https://www.cpc.com.tw/GetOilPriceJson.aspx?x=1');
    const d = await r.json();
    const w = d.Data[0];
    p92 = parseFloat(w["92無鉛汽油"]);
    p95 = parseFloat(w["95無鉛汽油"]);
    document.getElementById("date").innerHTML = `牌價實施日期：<b>${w.週別.replace('週','')}</b>　92：${p92} 元　95：${p95} 元`;
  }catch(e){
    document.getElementById("date").textContent="連線失敗，使用最近價格";
  }
  calc();
}

// 完整方案（已補到200公升以上）
const s92 = [[45,44,1],[46,45,1],[47,46,1],[48,46,2],[48,47,1],[49,47,2],[49,48,1],[50,48,2],[50,49,1],[51,49,2],[51,50,1],[52,50,2],[52,51,1],[53,51,2],[53,52,1],[54,52,2],[55,53,2],[55,54,1],[56,55,1],[57,56,1],[58,57,1],[59,58,1],[60,59,1],[61,59,2],[62,60,2],[62,61,1],[63,61,2],[64,62,2],[64,63,1],[65,64,1],[66,64,2],[66,65,1],[67,66,1],[68,66,2],[67,65,2],[69,68,1],[70,68,2],[72,70,2],[72,70,2],[73,71,2],[74,72,2],[75,73,2],[75,73,2],[77,75,2],[81,78,3],[77,75,2],[77,74,3],[79,77,2],[80,77,3],[79,76,3],[81,79,2],[82,79,3],[81,78,3],[84,81,3],[85,82,3],[86,84,2],[88,86,2],[89,86,3],[90,88,2],[91,88,3],[93,90,3],[95,93,2],[97,95,2],[104,102,2],[104,102,2],[114,110,4],[120,118,4],[130,127,4],[140,137,4],[150,147,4],[160,157,4],[170,167,4],[180,177,4],[190,187,4],[200,197,4]];
const s95 = [[47,46,1],[48,47,1],[49,48,1],[50,48,2],[50,49,1],[51,49,2],[51,50,1],[52,51,1],[53,52,1],[54,53,1],[55,54,1],[56,55,1],[57,56,1],[58,57,1],[59,58,1],[61,60,1],[62,61,1],[64,63,1],[65,64,1],[68,67,1],[69,68,1],[72,70,2],[72,71,1],[76,74,2],[77,75,2],[79,77,2],[80,78,2],[83,81,2],[84,82,2],[86,84,2],[87,85,2],[90,88,2],[93,91,2],[94,92,2],[97,95,2],[100,98,2],[104,102,2],[114,112,2],[125,122,3],[130,127,3],[140,137,3],[150,147,3],[160,157,3],[170,167,3],[180,177,3],[190,187,3],[200,197,3]];

function calc(){
  const disc92 = +document.getElementById("d92").value || 0;
  const disc95 = +document.getElementById("d95").value || 0;
  const all = [];

  if(mode==="home" || mode===92){
    s92.forEach(([f,s,m])=>{
      const disc = Math.min(m, disc92);
      const cost = s*p92 - disc;
      const litre = cost / p92;
      const real = cost / litre;
      all.push({oil:92, litre, real, save:f*p92-cost, full:f*p92, self:s*p92, disc});
    });
  }
  if(mode==="home" || mode===95){
    s95.forEach(([f,s,m])=>{
      const disc = Math.min(m, disc95);
      const cost = s*p95 - disc;
      const litre = cost / p95;
      const real = cost / litre;
      all.push({oil:95, litre, real, save:f*p95-cost, full:f*p95, self:s*p95, disc});
    });
  }

  all.sort((a,b)=>a.real - b.real);

  const tb = document.getElementById("tb");
  tb.innerHTML="";

  const showCount = mode==="home" ? 20 : all.length;
  all.slice(0, showCount).forEach((x,i)=>{
    const tr = document.createElement("tr");
    if(i===0) tr.className="best";
    const oilSpan = mode==="home" ? `<span class="o${x.oil}"><b>${x.oil}</b></span>` : `<b>${x.oil}</b>`;
    tr.innerHTML = `<td><b>${i+1}</b></td>
      <td>${oilSpan}</td>
      <td><b>${x.litre.toFixed(2)}</b></td>
      <td>${x.full.toFixed(0)}</td>
      <td>${x.self.toFixed(0)}</td>
      <td>${x.disc.toFixed(1)}</td>
      <td><b>${x.real.toFixed(2)}</b></td>
      <td>${x.save.toFixed(0)}</td>`;
    tb.appendChild(tr);
  });
}

// 點 92 或 95 進入該油種完整榜
function showOil(oil){
  mode = oil;
  document.getElementById("title").textContent = oil===92 ? "92無鉛汽油 完整最划算排名" : "95無鉛汽油 完整最划算排名";
  document.getElementById("back").style.display = "block";
  document.getElementById("tabs").style.display = "none";
  calc();
}

// 回到首頁 Top20
document.getElementById("back").onclick = e=>{
  e.preventDefault();
  mode = "home";
  document.getElementById("title").textContent = "中油自助最划算公升數 Top20";
  document.getElementById("back").style.display = "none";
  document.getElementById("tabs").style.display = "block";
  calc();
};

document.getElementById("d92").oninput =
document.getElementById("d95").oninput = calc;

getPrice();
setInterval(getPrice,86400000);
</script>
</body>
</html>
