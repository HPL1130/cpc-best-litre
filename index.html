<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中油優惠公升數</title>
    <style>
        body { font-family: Arial, sans-serif; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid black; padding: 8px; text-align: center; }
        input { width: 100px; }
        @media (max-width: 600px) {
            table { font-size: 12px; }
            input { width: 80px; }
        }
    </style>
</head>
<body>
    <h1>中油優惠公升數</h1>
    <p>牌價實施日期: <span id="date">載入中...</span></p>
    <p>92牌價: <span id="price92">載入中...</span> 元/升</p>
    <p>95牌價: <span id="price95">載入中...</span> 元/升</p>
    <label for="type">油種: </label>
    <select id="type">
        <option value="92">92</option>
        <option value="95">95</option>
    </select><br><br>
    <label for="discount">自助優惠減額 (元/升): </label>
    <input id="discount" type="number" step="0.1" value="0.8"><br><br>
    <button onclick="calc()">計算</button>
    <table id="table">
        <thead>
            <tr>
                <th>公升</th>
                <th>原價 (元)</th>
                <th>自助 (元)</th>
                <th>差價 (元)</th>
                <th>有效單價 (元/升)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        async function getPrices() {
            try {
                const response = await fetch('https://gas.goodlife.tw/');
                const text = await response.text();
                const match92 = text.match(/92: (\d+\.\d+)/);
                const match95 = text.match(/95: (\d+\.\d+)/);
                const matchDate = text.match(/本週油價調整時間: (\d{4}-\d{2}-\d{2})/);
                document.getElementById('price92').innerText = match92 ? match92[1] : '未知';
                document.getElementById('price95').innerText = match95 ? match95[1] : '未知';
                document.getElementById('date').innerText = matchDate ? matchDate[1] : '未知';
            } catch (e) {
                console.error(e);
                document.getElementById('price92').innerText = '未知';
                document.getElementById('price95').innerText = '未知';
                document.getElementById('date').innerText = '未知';
            }
        }
        getPrices();

        function calc() {
            const type = document.getElementById('type').value;
            const priceStr = document.getElementById(`price${type}`).innerText;
            const price = parseFloat(priceStr);
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            if (isNaN(price)) {
                alert('無法取得油價，請稍後重試。');
                return;
            }
            const results = [];
            for (let i = 100; i <= 15000; i++) {
                const L = i / 100;
                const originalTotal = Math.round(L * price);
                const selfTotal = Math.round(L * (price - discount));
                const diff = originalTotal - selfTotal;
                const effectivePrice = selfTotal / L;
                results.push({ L: L.toFixed(2), originalTotal, selfTotal, diff, effectivePrice });
            }
            // 排序：有效單價由小到大（最優惠在上）
            results.sort((a, b) => a.effectivePrice - b.effectivePrice);
            // 取前20筆
            const top20 = results.slice(0, 20);
            const tbody = document.getElementById('table').querySelector('tbody');
            tbody.innerHTML = '';
            top20.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.L}</td>
                    <td>${row.originalTotal}</td>
                    <td>${row.selfTotal}</td>
                    <td>${row.diff}</td>
                    <td>${row.effectivePrice.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
